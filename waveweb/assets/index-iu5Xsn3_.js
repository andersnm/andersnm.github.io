var St=Object.defineProperty;var kt=(o,s,t)=>s in o?St(o,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[s]=t;var a=(o,s,t)=>(kt(o,typeof s!="symbol"?s+"":s,t),t);(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();function _(o){return o?Array.isArray(o)?G(o):G([o]):[]}function G(o){const s=[];for(let t of o){const e=t.toDom();if(Array.isArray(e))for(let n of e)s.push(n);else s.push(e)}return s}function nt(o,s){for(let t of s)o.appendChild(t)}function it(o,s){let t=o;for(let e of s)t.after(e),t=e}function A(o,s){for(;o.nextSibling&&o.nextSibling!==s;){if(!o.parentElement)throw new Error("Internal error");o.parentElement.removeChild(o.nextSibling)}}function ot(o,s){if(o.nodeType===Node.ELEMENT_NODE){const t=[...o.childNodes].reverse();for(let e of t)ot(e,s)}s(o)}function rt(o,s){if(s(o),o.nodeType===Node.ELEMENT_NODE)for(let t of o.childNodes)rt(t,s)}function at(o,s,t){let e=o.get(s);e||(e=[],o.set(s,e)),e.push(t)}class yt{constructor(){a(this,"observer");a(this,"mountingNodes",new Map);a(this,"detachedNodes",new Map);a(this,"attachedNodes",new Map);this.observer=new MutationObserver((s,t)=>{for(const e of s)this.handleMutation(e)})}mount(s){const t={childList:!0,subtree:!0};this.observer.observe(s,t)}registerComponentLifetime(s,t){return at(this.mountingNodes,s,t),!0}handleMutation(s){for(let t of s.removedNodes)this.checkUnmounted(t);for(let t of s.addedNodes)this.checkMounted(t)}checkMounted(s){rt(s,t=>{let e=this.detachedNodes.get(t);if(e){this.detachedNodes.delete(t),this.attachedNodes.set(t,e);return}if(e=this.mountingNodes.get(t),e){this.mountingNodes.delete(t),this.attachedNodes.set(t,e);for(let n of e)n.beginMount(t)}})}checkUnmounted(s){ot(s,t=>{let e=this.mountingNodes.get(t);if(e&&this.mountingNodes.delete(t),e=this.attachedNodes.get(t),e){this.attachedNodes.delete(t);for(let n of e)n.beginUnmount()}})}}class Ct{constructor(){a(this,"watchers",[]);a(this,"targetProxies",new Map);a(this,"proxyTargets",new Map);a(this,"captures",[]);a(this,"resolveProps",!0);a(this,"rootTargets",new Map)}getProxyForObject(s,t){if(this.targetProxies.has(s))return this.targetProxies.get(s);const e=new Proxy(s,this.createProxyHandler(t));return this.proxyTargets.set(e,s),this.targetProxies.set(s,e),at(this.rootTargets,t,s),e}createProxyHandler(s){return{apply:(t,e,n)=>{throw new Error("We dont apply yet")},get:(t,e,n)=>{const i=t[e];return e==="rootCount"&&console.log("AT LEAST HERE!",i,t),e===Symbol.iterator?i:i instanceof D?(console.log("Not proxying Nutzobject"),i):Array.isArray(t)&&typeof i=="function"?i:typeof i=="function"?t.constructor.prototype[e]?(console.log("THIS IS A METHOD IN THE PROTOYPE - NOT EVALUATING"),i):this.resolveProps?i():i:(this.captures.length&&this.captures[this.captures.length-1].push({target:t,key:e}),typeof i=="object"&&i!=null?this.getProxyForObject(i,s):i)},set:(t,e,n,i)=>{const r=t[e];if(typeof r=="function")throw new Error("Cannot mutate computed prop");if(r!==n){const c=this.targetProxies.get(r);if(c){console.log("REPLACING PROXIED OBJECT"),this.targetProxies.delete(r),this.proxyTargets.delete(c);const d=this.rootTargets.get(s),g=(d==null?void 0:d.indexOf(r))??-1;g!==-1&&(console.log("(and root target)"),d==null||d.splice(g,1))}t[e]=n;const u=[...this.watchers];for(let d of u)d.target===t&&d.key===e&&d.handler&&d.handler(r)}return!0}}}clearRootTargets(s){const t=this.rootTargets.get(s);if(t){this.rootTargets.delete(s);for(let e of t){const n=this.targetProxies.get(e);n&&this.proxyTargets.delete(n),this.targetProxies.delete(e)}}}watch(s,t,e){const n={target:s,key:t,handler:e};return this.watchers.push({target:s,key:t,handler:e}),n}unwatch(s,t,e){const n=this.watchers.findIndex(r=>r.target===s&&t===r.key&&e===r.handler);return n===-1?null:this.watchers.splice(n,1)[0]}beginScope(){this.captures.push([])}endScope(){const s=this.captures.pop();if(!s)return[];for(let t=0;t<s.length;t++){const e=s[t];for(let n=t+1;n<s.length;){const i=s[n];e.target===i.target&&e.key===i.key?s.splice(n,1):n++}}return s}}const m=new Ct,k=new yt;class D{constructor(){}beginMount(s){this.mounted&&this.mounted(s)}beginUnmount(){this.unmounted&&this.unmounted()}}class U{constructor(){a(this,"watchHandlerMap",new Map)}watchMany(s,t,e){for(let n of t)this.watch(s,n.target,n.key,e)}watch(s,t,e,n){const i=m.watch(t,e,n);let r=this.watchHandlerMap.get(s);r||(r=[],this.watchHandlerMap.set(s,r)),r.push(i)}unwatchGroup(s){const t=this.watchHandlerMap.get(s);if(t)for(let e of t)m.unwatch(e.target,e.key,e.handler)}unwatchAll(){for(let s of this.watchHandlerMap.keys())this.unwatchGroup(s)}}class f extends D{constructor(t){super();a(this,"props");a(this,"model");a(this,"watchMap");this.props=m.getProxyForObject(t,this),this.model=t,this.watchMap=new U}watch(t,e,n){m.beginScope();const i=t[e],r=m.endScope();return this.watchMap.watchMany("+"+e,r,()=>{this.watchMap.unwatchGroup("+"+e),n(),this.watch(t,e,n)}),i}beginUnmount(){m.clearRootTargets(this),this.watchMap.unwatchAll(),super.beginUnmount()}dispatch(t,e,...n){m.resolveProps=!1;const i=t[e];m.resolveProps=!0,i&&i(...n)}toDom(){const t=this.render(),e=G(t);return k.registerComponentLifetime(e[0],this),e}}class h extends D{constructor(t,e){super();a(this,"model");a(this,"tagName");a(this,"watchMap");this.model=e,this.tagName=t,this.watchMap=new U}mounted(t){this.model.mounted&&this.model.mounted(t)}unmounted(){this.watchMap.unwatchAll()}bindAttribute(t,e){if(typeof this.model[e]=="function"){m.beginScope();const n=this.model[e](),i=m.endScope();this.watchMap.watchMany(e,i,()=>{this.watchMap.unwatchGroup(e),this.bindAttribute(t,e)}),t[e]=n}else this.model[e]!==void 0&&(t[e]=this.model[e])}bindChildNodes(t){if(this.model.content){m.beginScope();const e=this.model.content(),n=m.endScope(),i=_(e);nt(t,i),this.watchMap.watchMany("?element",n,()=>{for(this.watchMap.unwatchGroup("?element");t.firstChild;)t.removeChild(t.firstChild);this.bindChildNodes(t)})}}toDom(){const t=document.createElement(this.tagName);return this.bindAttribute(t,"id"),this.bindAttribute(t,"name"),this.bindAttribute(t,"checked"),this.bindAttribute(t,"className"),this.bindAttribute(t,"disabled"),this.bindAttribute(t,"htmlFor"),this.bindAttribute(t,"size"),this.bindAttribute(t,"type"),this.bindAttribute(t,"value"),this.bindAttribute(t,"width"),this.bindAttribute(t,"height"),this.bindChildNodes(t),this.model.click&&t.addEventListener("click",this.model.click),this.model.input&&t.addEventListener("input",this.model.input),this.model.change&&t.addEventListener("change",this.model.change),this.model.mousedown&&t.addEventListener("mousedown",this.model.mousedown),this.model.mousemove&&t.addEventListener("mousemove",this.model.mousemove),this.model.mouseup&&t.addEventListener("mouseup",this.model.mouseup),this.model.pointerdown&&t.addEventListener("pointerdown",this.model.pointerdown),this.model.pointermove&&t.addEventListener("pointermove",this.model.pointermove),this.model.pointerup&&t.addEventListener("pointerup",this.model.pointerup),k.registerComponentLifetime(t,this),t}}class N extends D{constructor(t){super();a(this,"model");a(this,"watchMap");this.model=t,this.watchMap=new U}unmounted(){this.watchMap.unwatchAll()}renderItems(t){const e=[];for(let n=0;n<t.length;n++){const i=t[n];if(typeof this.model.itemCallback=="function"){const r=this.model.itemCallback(i,n),c=_(r);e.push(...c)}}return e}bindItems(t,e){m.beginScope();const n=this.model.items(),i=m.endScope(),r=this.renderItems(n);it(t,r),this.watchMap.watchMany("for",i,()=>{console.log("array changed (not the first time)!"),this.watchMap.unwatchGroup("for"),A(t,e),this.bindItems(t,e)})}toDom(){const t=document.createComment("Redraw-If"),e=document.createComment("/Redraw-If");m.beginScope();const n=this.model.items(),i=m.endScope();this.watchMap.watchMany("for",i,()=>{console.log("array changed!"),this.watchMap.unwatchGroup("for"),A(t,e),this.bindItems(t,e)});const r=this.renderItems(n);return k.registerComponentLifetime(t,this),[t,...r,e]}}class H extends D{constructor(t){super();a(this,"content");a(this,"watchMap",new U);this.content=t}unmounted(){this.watchMap.unwatchAll()}bindSlot(t,e){m.beginScope();const n=this.content(),i=m.endScope(),r=_(n);it(t,r),this.watchMap.watchMany("slot",i,()=>{this.watchMap.unwatchGroup("slot"),A(t,e),this.bindSlot(t,e)})}toDom(){const t=document.createComment("NutzSlot"),e=document.createComment("/NutzSlot");m.beginScope();const n=this.content(),i=m.endScope();return this.watchMap.watchMany("slot",i,()=>{this.watchMap.unwatchGroup("slot"),A(t,e),this.bindSlot(t,e)}),k.registerComponentLifetime(t,this),[t,..._(n),e]}}class p extends D{constructor(t){super();a(this,"watchHandlers");a(this,"text");this.text=t,this.watchHandlers=[]}unmounted(){this.unbindWatches()}bindText(t){if(this.unbindWatches(),typeof this.text=="function"){m.beginScope();const e=this.text(),n=m.endScope();for(let i of n){const r=m.watch(i.target,i.key,()=>this.bindText(t));this.watchHandlers.push(r)}t.textContent=e}else t.textContent=this.text}unbindWatches(){for(let t of this.watchHandlers)m.unwatch(t.target,t.key,t.handler);this.watchHandlers.length=0}toDom(){const t=document.createTextNode("");return this.bindText(t),k.registerComponentLifetime(t,this),t}}class Nt extends f{render(){return[new h("table",{content:()=>[new N({items:()=>this.props.rows,itemCallback:(s,t)=>new h("tr",{className:()=>s.selected?"bg-neutral-100 text-neutral-800":"unselected",click:e=>{console.log("click row"),this.dispatch(this.props,"select",s,t)},content:()=>[new N({items:()=>s.values,itemCallback:e=>new h("td",{content:()=>new p(e)})})]})})]})]}}class T extends f{render(){return[new h("div",{className:"mb-4 rounded-lg p-1 bg-neutral-600",content:()=>[new h("label",{className:"block text-sm font-bold mb-1",content:()=>[new p(()=>this.props.label)]}),...this.props.input]})]}}const z=class z extends f{render(){const s="id"+z.idCounter;return z.idCounter++,[new h("div",{className:"flex items-center",content:()=>[new h("input",{id:s,type:"radio",className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600",name:()=>this.props.name,value:()=>this.props.value,checked:()=>this.props.checked,change:t=>this.dispatch(this.props,"change",t.target.value)}),new h("label",{className:"ms-2 text-sm font-medium",content:()=>[new p(this.props.label)],htmlFor:s})]})]}};a(z,"idCounter",0);let V=z;class ht extends f{render(){return[new T({label:()=>this.props.label,input:[new N({items:()=>this.props.items,itemCallback:s=>new V({label:s.text,value:s.value,name:this.props.name,checked:()=>s.value==this.props.value,change:t=>this.dispatch(this.props,"change",t)})})]})]}}class Mt extends f{createFrame(s){const t=this.props.frames[s];m.proxyTargets.get(t)||console.log("INTERNAL ERROR - PROXYTARGET NOT SET FOR",t,s);const{where:n,stack:i}=t,r=i==="horizontal"?"flex-row":"flex-col";return n==="left"?new h("div",{className:"flex flex-row flex-1 frame-left",content:()=>[new h("div",{className:"flex "+r+" w-80 border-r-2 border-transparent",content:()=>t.content}),this.createFrame(s+1)]}):n==="right"?new h("div",{className:"flex flex-row flex-1 frame-right",content:()=>[this.createFrame(s+1),new h("div",{className:"flex "+r+" w-80  border-l-2 border-transparent",content:()=>t.content})]}):n==="main"?new h("div",{className:"flex "+r+" flex-1 frame-top-or-bottom-TODO",content:()=>t.content}):new h("div",{className:"flex flex-col flex-1 frame-top-or-bottom-TODO",content:()=>[new h("div",{className:"flex "+r+" min-w-48",content:()=>t.content}),this.createFrame(s+1)]})}render(){return[this.createFrame(0)]}}class Rt extends f{render(){return[new h("div",{className:"flex flex-row h-full w-full overflow-hidden",content:()=>this.props.content})]}}class Dt extends f{mounted(){}render(){return[new h("div",{className:"relative z-10",content:()=>[new h("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"}),new h("div",{className:"fixed inset-0 z-10 w-screen overflow-y-auto",content:()=>[new h("div",{className:"flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0",content:()=>new h("div",{className:"relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg",content:()=>this.props.content,click:s=>s.stopPropagation()}),click:s=>{console.log("click TODO"),this.dispatch(this.props,"click",s)}})]})]})]}}class ct extends f{render(){return[new h("div",{className:"flex flex-col h-full w-full",content:()=>[new h("div",{className:"flex flex-row px-1 py-1 bg-neutral-600",content:()=>[new h("div",{className:"grow text-white font-bold",content:()=>this.props.title}),new h("div",{className:"grow-0 flex",content:()=>this.props.titleRight})]}),new h("div",{className:"h-full w-full p-1 bg-neutral-600",content:()=>[new h("div",{className:"flex flex-col h-full w-full p-1 bg-neutral-800 rounded-lg overflow-auto text-white",content:()=>this.props.content})]})]})]}}class K extends f{mounted(){}render(){return[new H(()=>this.props.visible?[new Dt({content:[new ct({title:[new p(()=>this.props.title)],titleRight:[new p("X")],content:this.props.content})],click:s=>this.dispatch(this.props,"click",s)})]:[])]}}class xt extends f{render(){return[new h("div",{className:"flex gap-1 bg-neutral-800",content:()=>[new N({items:()=>this.props.tabs,itemCallback:(s,t)=>(console.log("WE HAVE INDEX",t),new h("div",{className:()=>"font-bold py-1 px-2 hover:underline "+(this.props.position==="top"?"rounded-t-lg ":"rounded-b-lg ")+(this.props.currentTab===t?"bg-neutral-600 text-white":"bg-neutral-800 hover:bg-neutral-600 text-gray-400"),content:()=>s.content,click:()=>this.model.change(new CustomEvent("change",{detail:t}))}))})]})]}}class Pt extends f{render(){const s=(e,n)=>e.where==="main"?[n,new h("div",{className:"h-full w-full p-1 bg-neutral-600",content:()=>[new h("div",{className:"flex flex-col h-full w-full p-1 bg-neutral-800 rounded-lg overflow-auto text-white",content:()=>{var i;return(i=e.tabs[e.currentTab])==null?void 0:i.content}})]})]:[new ct({title:[new p(()=>e.tabs[e.currentTab].title)],titleRight:[new p("title")],content:[new H(()=>e.tabs[e.currentTab].content)]}),n],t={frames:this.props.frames.map(e=>({size:e.size,where:e.where,stack:"vertical",content:s(e,new xt({currentTab:()=>e.currentTab,position:()=>e.where==="main"?"top":"bottom",tabs:()=>e.tabs.map(n=>({content:[new p(n.title)]})),change:n=>{console.log("CHANGTAB",n.detail),e.currentTab=n.detail,this.dispatch(e,"selectTab",n.detail),console.log(e)}}))}))};return[new Mt(t)]}}class Et extends f{constructor(){super(...arguments);a(this,"pollInterval")}mounted(){this.pollInterval=setInterval(()=>{console.log("UPDATING STATS");let t=0;for(let e of m.rootTargets.keys()){const n=m.rootTargets.get(e);t+=(n==null?void 0:n.length)??0}this.props.watchCount=m.watchers.length,this.props.proxyCount=m.proxyTargets.size,this.props.rootCount=m.rootTargets.size,this.props.rootTargetCount=t,this.props.mountingCount=k.mountingNodes.size,this.props.attachedCount=k.attachedNodes.size,this.props.detachedCount=k.detachedNodes.size},1e3)}unmounted(){clearInterval(this.pollInterval)}render(){return[new h("div",{className:"mb-4 rounded-lg p-1 bg-neutral-600",content:()=>[new h("h1",{className:"text-lg",content:()=>new p("Internal stats")}),new h("table",{className:"w-full",content:()=>[new h("tr",{content:()=>[new h("td",{content:()=>new p("Watches")}),new h("td",{className:"text-right",content:()=>new p(()=>{var t;return((t=this.props.watchCount)==null?void 0:t.toString())??""})})]}),new h("tr",{content:()=>[new h("td",{content:()=>new p("Proxies")}),new h("td",{className:"text-right",content:()=>new p(()=>{var t;return((t=this.props.proxyCount)==null?void 0:t.toString())??""})})]}),new h("tr",{content:()=>[new h("td",{content:()=>new p("Roots")}),new h("td",{className:"text-right",content:()=>new p(()=>{var t;return((t=this.props.rootCount)==null?void 0:t.toString())??""})})]}),new h("tr",{content:()=>[new h("td",{content:()=>new p("Root Targets")}),new h("td",{className:"text-right",content:()=>new p(()=>{var t;return((t=this.props.rootTargetCount)==null?void 0:t.toString())??""})})]}),new h("tr",{content:()=>[new h("td",{content:()=>new p("Attached Nodes")}),new h("td",{className:"text-right",content:()=>new p(()=>{var t;return((t=this.props.attachedCount)==null?void 0:t.toString())??""})})]}),new h("tr",{content:()=>[new h("td",{content:()=>new p("Detached Nodes")}),new h("td",{className:"text-right",content:()=>new p(()=>{var t;return((t=this.props.detachedCount)==null?void 0:t.toString())??""})})]})]})]})]}}function lt(o,s,t=0,e=o.length){for(let n=t;n<e;n+=s)zt(o,s,n)}function zt(o,s,t){s--;for(let e=0;e<s;e++){let n=o[t+e];o[t+e]=o[t+s],o[t+s]=n,s--}}function Tt(o,s=0,t=o.length){let e="";for(let n=s;n<t;){let i=128,r=191,c=!1,u=o[n++];if(u>=0&&u<=127)e+=String.fromCharCode(u);else{let d=0;u>=194&&u<=223?d=1:u>=224&&u<=239?(d=2,o[n]===224&&(i=160),o[n]===237&&(r=159)):u>=240&&u<=244?(d=3,o[n]===240&&(i=144),o[n]===244&&(r=143)):c=!0,u=u&(1<<8-d-1)-1;for(let g=0;g<d;g++)(o[n]<i||o[n]>r)&&(c=!0),u=u<<6|o[n]&63,n++;c?e+="ï¿½":u<=65535?e+=String.fromCharCode(u):(u-=65536,e+=String.fromCharCode((u>>10&1023)+55296,(u&1023)+56320))}}return e}function ut(o,s,t=0){let e=0,n=o.length;for(;e<n;){let i=o.codePointAt(e);if(i<128)s[t]=i,t++;else{let r=0,c=0;for(i<=2047?(r=1,c=192):i<=65535?(r=2,c=224):i<=1114111&&(r=3,c=240,e++),s[t]=(i>>6*r)+c,t++;r>0;)s[t]=128|i>>6*(r-1)&63,t++,r--}e++}return t}class Lt{constructor(s,t=!1){a(this,"bits");a(this,"offset");a(this,"max");a(this,"min");a(this,"unpack");this.bits=s,this.offset=Math.ceil(s/8),this.max=Math.pow(2,s)-1,this.min=0,this.unpack=this.unpack_,t&&(this.max=Math.pow(2,s)/2-1,this.min=-this.max-1,this.unpack=this.unpackSigned_)}pack(s,t,e=0){t=this.clamp_(Math.round(t));for(let n=0,i=this.offset;n<i;n++)s[e]=Math.floor(t/Math.pow(2,n*8))&255,e++;return e}unpack_(s,t=0){let e=0;for(let n=0;n<this.offset;n++)e+=s[t+n]*Math.pow(256,n);return e}unpackSigned_(s,t=0){return this.sign_(this.unpack_(s,t))}clamp_(s){return s>this.max?this.max:s<this.min?this.min:s}sign_(s){return s>this.max&&(s-=this.max*2+2),s}}class Q{constructor(s,t){a(this,"offset");a(this,"ebits");a(this,"fbits");a(this,"bias");a(this,"biasP2");a(this,"ebitsFbits");a(this,"fbias");this.offset=Math.ceil((s+t)/8),this.ebits=s,this.fbits=t,this.bias=(1<<s-1)-1,this.biasP2=Math.pow(2,this.bias+1),this.ebitsFbits=s+t,this.fbias=Math.pow(2,-(8*this.offset-1-s))}pack(s,t,e){Math.abs(t)>this.biasP2-this.ebitsFbits*2&&(t=t<0?-1/0:1/0);let n=((t=+t)||1/t)<0||t<0?1:0;t=Math.abs(t);let i=Math.min(Math.floor(Math.log(t)/Math.LN2),1023),r=W(t/Math.pow(2,i)*Math.pow(2,this.fbits));return t!==t?(r=Math.pow(2,this.fbits-1),i=(1<<this.ebits)-1):t!==0&&(t>=Math.pow(2,1-this.bias)?(r/Math.pow(2,this.fbits)>=2&&(i=i+1,r=1),i>this.bias?(i=(1<<this.ebits)-1,r=0):(i=i+this.bias,r=W(r)-Math.pow(2,this.fbits))):(r=W(t/Math.pow(2,1-this.bias-this.fbits)),i=0)),this.packFloatBits_(s,e,n,i,r)}unpack(s,t){let e=(1<<this.ebits)-1,n,i="";for(let u=this.offset-1;u>=0;u--){let d=s[u+t].toString(2);i+="00000000".substring(d.length)+d}let r=i.charAt(0)=="1"?-1:1;i=i.substring(1);let c=parseInt(i.substring(0,this.ebits),2);return i=i.substring(this.ebits),c==e?parseInt(i,2)!==0?NaN:r*(1/0):(c===0?(c+=1,n=parseInt(i,2)):n=parseInt("1"+i,2),r*n*this.fbias*Math.pow(2,c-this.bias))}packFloatBits_(s,t,e,n,i){let r=[];r.push(e);for(let w=this.ebits;w>0;w-=1)r[w]=n%2?1:0,n=Math.floor(n/2);let c=r.length;for(let w=this.fbits;w>0;w-=1)r[c+w]=i%2?1:0,i=Math.floor(i/2);let u=r.join(""),d=this.offset+t-1,g=t;for(;d>=t;)s[d]=parseInt(u.substring(0,8),2),u=u.substring(8),d--,g++;return g}}function W(o){let s=Math.floor(o),t=o-s;return t<.5?s:t>.5||s%2?s+1:s}function R(o,s=0,t=o.length){return Tt(o,s,t)}function b(o){let s=[];return ut(o,s),s}function $(o,s,t=0){return ut(o,s,t)}function dt(o,s,t,e=0){s=s||{};let n=mt(s.bits,s.fp,s.signed),i=Math.ceil(s.bits/8),r=0,c=e;for(let u=o.length;r<u;r++)e=n.pack(t,o[r],e);return s.be&&lt(t,i,c,e),e}function pt(o,s,t,e=0,n=o.length){s=s||{};let i=mt(s.bits,s.fp,s.signed);if(n=At(o,e,n,i.offset),s.be){let r=_t(o);s.be&&lt(r,i.offset,e,n),tt(r,t,e,n,i)}else tt(o,t,e,n,i)}function q(o,s,t,e=0){return dt([o],s,t,e)}function l(o,s){let t=[];return q(o,s,t,0),t}function F(o,s,t=0){let e=[];return pt(o,s,e,t,t+Math.ceil(s.bits/8)),e[0]}function tt(o,s,t,e,n){let i=n.offset;for(let r=0,c=t;c<e;c+=i,r++)s[r]=n.unpack(o,c)}function _t(o){return new Uint8Array(o)}function At(o,s,t,e){let n=(t-s)%e;return t-n}function mt(o,s,t){return s&&o==32?new Q(8,23):s&&o==64?new Q(11,52):new Lt(o,t)}class Ft{constructor(){a(this,"container");a(this,"chunkSize");a(this,"format");a(this,"signature");a(this,"head");a(this,"uInt32");a(this,"supported_containers");this.container="",this.chunkSize=0,this.format="",this.signature=null,this.head=0,this.uInt32={bits:32,be:!1},this.supported_containers=["RIFF","RIFX"]}setSignature(s){if(this.head=0,this.container=this.readString(s,4),this.supported_containers.indexOf(this.container)===-1)throw Error("Not a supported format."+this.container);this.uInt32.be=this.container==="RIFX",this.chunkSize=this.readUInt32(s),this.format=this.readString(s,4),this.signature={chunkId:this.container,chunkSize:this.chunkSize,format:this.format,subChunks:this.getSubChunksIndex_(s)}}findChunk(s,t=!1){let e=this.signature.subChunks,n=[];for(let i=0;i<e.length;i++)if(e[i].chunkId==s)if(t)n.push(e[i]);else return e[i];return s=="LIST"&&n.length?n:null}readString(s,t){let e="";return e=R(s,this.head,this.head+t),this.head+=t,e}readUInt32(s){let t=F(s,this.uInt32,this.head);return this.head+=4,t}getSubChunksIndex_(s){let t=[],e=this.head;for(;e<=s.length-8;)t.push(this.getSubChunkIndex_(s,e)),e+=8+t[t.length-1].chunkSize,e=e%2?e+1:e;return t}getSubChunkIndex_(s,t){let e={chunkId:this.getChunkId_(s,t),chunkSize:this.getChunkSize_(s,t)};if(e.chunkId=="LIST")e.format=R(s,t+8,t+12),this.head+=4,e.subChunks=this.getSubChunksIndex_(s);else{let n=e.chunkSize%2?e.chunkSize+1:e.chunkSize;this.head=t+8+n,e.chunkData={start:t+8,end:this.head}}return e}getChunkId_(s,t){return this.head+=4,R(s,t,t+4)}getChunkSize_(s,t){return this.head+=4,F(s,this.uInt32,t+4)}}class Y extends Ft{constructor(){super();a(this,"fmt");a(this,"fact");a(this,"cue");a(this,"smpl");a(this,"bext");a(this,"iXML");a(this,"ds64");a(this,"data");a(this,"LIST");a(this,"junk");a(this,"_PMX");a(this,"uInt16");this.supported_containers.push("RF64"),this.fmt={chunkId:"",chunkSize:0,audioFormat:0,numChannels:0,sampleRate:0,byteRate:0,blockAlign:0,bitsPerSample:0,cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]},this.fact={chunkId:"",chunkSize:0,dwSampleLength:0},this.cue={chunkId:"",chunkSize:0,dwCuePoints:0,points:[]},this.smpl={chunkId:"",chunkSize:0,dwManufacturer:0,dwProduct:0,dwSamplePeriod:0,dwMIDIUnityNote:0,dwMIDIPitchFraction:0,dwSMPTEFormat:0,dwSMPTEOffset:0,dwNumSampleLoops:0,dwSamplerData:0,loops:[]},this.bext={chunkId:"",chunkSize:0,description:"",originator:"",originatorReference:"",originationDate:"",originationTime:"",timeReference:[0,0],version:0,UMID:"",loudnessValue:0,loudnessRange:0,maxTruePeakLevel:0,maxMomentaryLoudness:0,maxShortTermLoudness:0,reserved:"",codingHistory:""},this.iXML={chunkId:"",chunkSize:0,value:""},this.ds64={chunkId:"",chunkSize:0,riffSizeHigh:0,riffSizeLow:0,dataSizeHigh:0,dataSizeLow:0,originationTime:0,sampleCountHigh:0,sampleCountLow:0},this.data={chunkId:"",chunkSize:0,samples:new Uint8Array(0)},this.LIST=[],this.junk={chunkId:"",chunkSize:0,chunkData:[]},this._PMX={chunkId:"",chunkSize:0,value:""},this.uInt16={bits:16,be:!1,signed:!1,fp:!1}}fromBuffer(t,e=!0){if(this.clearHeaders(),this.setSignature(t),this.uInt16.be=this.uInt32.be,this.format!="WAVE")throw Error('Could not find the "WAVE" format identifier');this.readDs64Chunk_(t),this.readFmtChunk_(t),this.readFactChunk_(t),this.readBextChunk_(t),this.readiXMLChunk_(t),this.readCueChunk_(t),this.readSmplChunk_(t),this.readDataChunk_(t,e),this.readJunkChunk_(t),this.readLISTChunk_(t),this.read_PMXChunk_(t)}clearHeaders(){let t=new Y;Object.assign(this.fmt,t.fmt),Object.assign(this.fact,t.fact),Object.assign(this.cue,t.cue),Object.assign(this.smpl,t.smpl),Object.assign(this.bext,t.bext),Object.assign(this.iXML,t.iXML),Object.assign(this.ds64,t.ds64),Object.assign(this.data,t.data),this.LIST=[],Object.assign(this.junk,t.junk),Object.assign(this._PMX,t._PMX)}readFmtChunk_(t){let e=this.findChunk("fmt ");if(e)this.head=e.chunkData.start,this.fmt.chunkId=e.chunkId,this.fmt.chunkSize=e.chunkSize,this.fmt.audioFormat=this.readUInt16_(t),this.fmt.numChannels=this.readUInt16_(t),this.fmt.sampleRate=this.readUInt32(t),this.fmt.byteRate=this.readUInt32(t),this.fmt.blockAlign=this.readUInt16_(t),this.fmt.bitsPerSample=this.readUInt16_(t),this.readFmtExtension_(t);else throw Error('Could not find the "fmt " chunk')}readFmtExtension_(t){this.fmt.chunkSize>16&&(this.fmt.cbSize=this.readUInt16_(t),this.fmt.chunkSize>18&&(this.fmt.validBitsPerSample=this.readUInt16_(t),this.fmt.chunkSize>20&&(this.fmt.dwChannelMask=this.readUInt32(t),this.fmt.subformat=[this.readUInt32(t),this.readUInt32(t),this.readUInt32(t),this.readUInt32(t)])))}readFactChunk_(t){let e=this.findChunk("fact");e&&(this.head=e.chunkData.start,this.fact.chunkId=e.chunkId,this.fact.chunkSize=e.chunkSize,this.fact.dwSampleLength=this.readUInt32(t))}readCueChunk_(t){let e=this.findChunk("cue ");if(e){this.head=e.chunkData.start,this.cue.chunkId=e.chunkId,this.cue.chunkSize=e.chunkSize,this.cue.dwCuePoints=this.readUInt32(t);for(let n=0;n<this.cue.dwCuePoints;n++)this.cue.points.push({dwName:this.readUInt32(t),dwPosition:this.readUInt32(t),fccChunk:this.readString(t,4),dwChunkStart:this.readUInt32(t),dwBlockStart:this.readUInt32(t),dwSampleOffset:this.readUInt32(t)})}}readSmplChunk_(t){let e=this.findChunk("smpl");if(e){this.head=e.chunkData.start,this.smpl.chunkId=e.chunkId,this.smpl.chunkSize=e.chunkSize,this.smpl.dwManufacturer=this.readUInt32(t),this.smpl.dwProduct=this.readUInt32(t),this.smpl.dwSamplePeriod=this.readUInt32(t),this.smpl.dwMIDIUnityNote=this.readUInt32(t),this.smpl.dwMIDIPitchFraction=this.readUInt32(t),this.smpl.dwSMPTEFormat=this.readUInt32(t),this.smpl.dwSMPTEOffset=this.readUInt32(t),this.smpl.dwNumSampleLoops=this.readUInt32(t),this.smpl.dwSamplerData=this.readUInt32(t);for(let n=0;n<this.smpl.dwNumSampleLoops;n++)this.smpl.loops.push({dwName:this.readUInt32(t),dwType:this.readUInt32(t),dwStart:this.readUInt32(t),dwEnd:this.readUInt32(t),dwFraction:this.readUInt32(t),dwPlayCount:this.readUInt32(t)})}}readDataChunk_(t,e){let n=this.findChunk("data");if(n)this.data.chunkId="data",this.data.chunkSize=n.chunkSize,e&&(this.data.samples=t.slice(n.chunkData.start,n.chunkData.end));else throw Error('Could not find the "data" chunk')}readBextChunk_(t){let e=this.findChunk("bext");e&&(this.head=e.chunkData.start,this.bext.chunkId=e.chunkId,this.bext.chunkSize=e.chunkSize,this.bext.description=this.readString(t,256),this.bext.originator=this.readString(t,32),this.bext.originatorReference=this.readString(t,32),this.bext.originationDate=this.readString(t,10),this.bext.originationTime=this.readString(t,8),this.bext.timeReference=[this.readUInt32(t),this.readUInt32(t)],this.bext.version=this.readUInt16_(t),this.bext.UMID=this.readString(t,64),this.bext.loudnessValue=this.readUInt16_(t),this.bext.loudnessRange=this.readUInt16_(t),this.bext.maxTruePeakLevel=this.readUInt16_(t),this.bext.maxMomentaryLoudness=this.readUInt16_(t),this.bext.maxShortTermLoudness=this.readUInt16_(t),this.bext.reserved=this.readString(t,180),this.bext.codingHistory=this.readString(t,this.bext.chunkSize-602))}readiXMLChunk_(t){let e=this.findChunk("iXML");e&&(this.head=e.chunkData.start,this.iXML.chunkId=e.chunkId,this.iXML.chunkSize=e.chunkSize,this.iXML.value=R(t,this.head,this.head+this.iXML.chunkSize))}readDs64Chunk_(t){let e=this.findChunk("ds64");if(e)this.head=e.chunkData.start,this.ds64.chunkId=e.chunkId,this.ds64.chunkSize=e.chunkSize,this.ds64.riffSizeHigh=this.readUInt32(t),this.ds64.riffSizeLow=this.readUInt32(t),this.ds64.dataSizeHigh=this.readUInt32(t),this.ds64.dataSizeLow=this.readUInt32(t),this.ds64.originationTime=this.readUInt32(t),this.ds64.sampleCountHigh=this.readUInt32(t),this.ds64.sampleCountLow=this.readUInt32(t);else if(this.container=="RF64")throw Error('Could not find the "ds64" chunk')}readLISTChunk_(t){let e=this.findChunk("LIST",!0);if(e!==null)for(let n=0;n<e.length;n++){let i=e[n];this.LIST.push({chunkId:i.chunkId,chunkSize:i.chunkSize,format:i.format,subChunks:[]});for(let r=0;r<i.subChunks.length;r++)this.readLISTSubChunks_(i.subChunks[r],i.format,t)}}readLISTSubChunks_(t,e,n){e=="adtl"?["labl","note","ltxt"].indexOf(t.chunkId)>-1&&this.readLISTadtlSubChunks_(n,t):e=="INFO"&&this.readLISTINFOSubChunks_(n,t)}readLISTadtlSubChunks_(t,e){this.head=e.chunkData.start;let n={chunkId:e.chunkId,chunkSize:e.chunkSize,dwName:this.readUInt32(t)};e.chunkId=="ltxt"?(n.dwSampleLength=this.readUInt32(t),n.dwPurposeID=this.readUInt32(t),n.dwCountry=this.readUInt16_(t),n.dwLanguage=this.readUInt16_(t),n.dwDialect=this.readUInt16_(t),n.dwCodePage=this.readUInt16_(t),n.value=""):n.value=this.readZSTR_(t,this.head),this.LIST[this.LIST.length-1].subChunks.push(n)}readLISTINFOSubChunks_(t,e){this.head=e.chunkData.start,this.LIST[this.LIST.length-1].subChunks.push({chunkId:e.chunkId,chunkSize:e.chunkSize,value:this.readZSTR_(t,this.head)})}readJunkChunk_(t){let e=this.findChunk("junk");e&&(this.junk={chunkId:e.chunkId,chunkSize:e.chunkSize,chunkData:[].slice.call(t.slice(e.chunkData.start,e.chunkData.end))})}read_PMXChunk_(t){let e=this.findChunk("_PMX");e&&(this.head=e.chunkData.start,this._PMX.chunkId=e.chunkId,this._PMX.chunkSize=e.chunkSize,this._PMX.value=R(t,this.head,this.head+this._PMX.chunkSize))}readZSTR_(t,e=0){for(let n=e;n<t.length&&(this.head++,t[n]!==0);n++);return R(t,e,this.head-1)}readUInt16_(t){let e=F(t,this.uInt16,this.head);return this.head+=2,e}}function v(o,s){let t=b(o);for(let e=t.length;e<s;e++)t.push(0);return t}class Bt extends Y{toBuffer(){this.uInt16.be=this.container==="RIFX",this.uInt32.be=this.uInt16.be;let s=[this.getJunkBytes_(),this.getDs64Bytes_(),this.getBextBytes_(),this.getiXMLBytes_(),this.getFmtBytes_(),this.getFactBytes_(),b(this.data.chunkId),l(this.data.samples.length,this.uInt32),this.data.samples,this.getCueBytes_(),this.getSmplBytes_(),this.getLISTBytes_(),this.get_PMXBytes_()],t=0;for(let i=0;i<s.length;i++)t+=s[i].length;let e=new Uint8Array(t+12),n=0;n=$(this.container,e,n),n=q(t+4,this.uInt32,e,n),n=$(this.format,e,n);for(let i=0;i<s.length;i++)e.set(s[i],n),n+=s[i].length;return e}getBextBytes_(){let s=[];return this.enforceBext_(),this.bext.chunkId&&(this.bext.chunkSize=602+this.bext.codingHistory.length,s=s.concat(b(this.bext.chunkId),l(602+this.bext.codingHistory.length,this.uInt32),v(this.bext.description,256),v(this.bext.originator,32),v(this.bext.originatorReference,32),v(this.bext.originationDate,10),v(this.bext.originationTime,8),l(this.bext.timeReference[0],this.uInt32),l(this.bext.timeReference[1],this.uInt32),l(this.bext.version,this.uInt16),v(this.bext.UMID,64),l(this.bext.loudnessValue,this.uInt16),l(this.bext.loudnessRange,this.uInt16),l(this.bext.maxTruePeakLevel,this.uInt16),l(this.bext.maxMomentaryLoudness,this.uInt16),l(this.bext.maxShortTermLoudness,this.uInt16),v(this.bext.reserved,180),v(this.bext.codingHistory,this.bext.codingHistory.length))),this.enforceByteLen_(s),s}enforceBext_(){for(let s in this.bext)if(this.bext.hasOwnProperty(s)&&this.bext[s]&&s!="timeReference"){this.bext.chunkId="bext";break}(this.bext.timeReference[0]||this.bext.timeReference[1])&&(this.bext.chunkId="bext")}getiXMLBytes_(){let s=[];if(this.iXML.chunkId){let t=b(this.iXML.value);this.iXML.chunkSize=t.length,s=s.concat(b(this.iXML.chunkId),l(this.iXML.chunkSize,this.uInt32),t)}return this.enforceByteLen_(s),s}getDs64Bytes_(){let s=[];return this.ds64.chunkId&&(s=s.concat(b(this.ds64.chunkId),l(this.ds64.chunkSize,this.uInt32),l(this.ds64.riffSizeHigh,this.uInt32),l(this.ds64.riffSizeLow,this.uInt32),l(this.ds64.dataSizeHigh,this.uInt32),l(this.ds64.dataSizeLow,this.uInt32),l(this.ds64.originationTime,this.uInt32),l(this.ds64.sampleCountHigh,this.uInt32),l(this.ds64.sampleCountLow,this.uInt32))),this.enforceByteLen_(s),s}getCueBytes_(){let s=[];if(this.cue.chunkId){let t=this.getCuePointsBytes_();s=s.concat(b(this.cue.chunkId),l(t.length+4,this.uInt32),l(this.cue.dwCuePoints,this.uInt32),t)}return this.enforceByteLen_(s),s}getCuePointsBytes_(){let s=[];for(let t=0;t<this.cue.dwCuePoints;t++)s=s.concat(l(this.cue.points[t].dwName,this.uInt32),l(this.cue.points[t].dwPosition,this.uInt32),b(this.cue.points[t].fccChunk),l(this.cue.points[t].dwChunkStart,this.uInt32),l(this.cue.points[t].dwBlockStart,this.uInt32),l(this.cue.points[t].dwSampleOffset,this.uInt32));return s}getSmplBytes_(){let s=[];if(this.smpl.chunkId){let t=this.getSmplLoopsBytes_();s=s.concat(b(this.smpl.chunkId),l(t.length+36,this.uInt32),l(this.smpl.dwManufacturer,this.uInt32),l(this.smpl.dwProduct,this.uInt32),l(this.smpl.dwSamplePeriod,this.uInt32),l(this.smpl.dwMIDIUnityNote,this.uInt32),l(this.smpl.dwMIDIPitchFraction,this.uInt32),l(this.smpl.dwSMPTEFormat,this.uInt32),l(this.smpl.dwSMPTEOffset,this.uInt32),l(this.smpl.dwNumSampleLoops,this.uInt32),l(this.smpl.dwSamplerData,this.uInt32),t)}return this.enforceByteLen_(s),s}getSmplLoopsBytes_(){let s=[];for(let t=0;t<this.smpl.dwNumSampleLoops;t++)s=s.concat(l(this.smpl.loops[t].dwName,this.uInt32),l(this.smpl.loops[t].dwType,this.uInt32),l(this.smpl.loops[t].dwStart,this.uInt32),l(this.smpl.loops[t].dwEnd,this.uInt32),l(this.smpl.loops[t].dwFraction,this.uInt32),l(this.smpl.loops[t].dwPlayCount,this.uInt32));return s}getFactBytes_(){let s=[];return this.fact.chunkId&&(s=s.concat(b(this.fact.chunkId),l(this.fact.chunkSize,this.uInt32),l(this.fact.dwSampleLength,this.uInt32))),this.enforceByteLen_(s),s}getFmtBytes_(){let s=[];if(this.fmt.chunkId){let t=s.concat(b(this.fmt.chunkId),l(this.fmt.chunkSize,this.uInt32),l(this.fmt.audioFormat,this.uInt16),l(this.fmt.numChannels,this.uInt16),l(this.fmt.sampleRate,this.uInt32),l(this.fmt.byteRate,this.uInt32),l(this.fmt.blockAlign,this.uInt16),l(this.fmt.bitsPerSample,this.uInt16),this.getFmtExtensionBytes_());return this.enforceByteLen_(t),t}throw Error('Could not find the "fmt " chunk')}getFmtExtensionBytes_(){let s=[];return this.fmt.chunkSize>16&&(s=s.concat(l(this.fmt.cbSize,this.uInt16))),this.fmt.chunkSize>18&&(s=s.concat(l(this.fmt.validBitsPerSample,this.uInt16))),this.fmt.chunkSize>20&&(s=s.concat(l(this.fmt.dwChannelMask,this.uInt32))),this.fmt.chunkSize>24&&(s=s.concat(l(this.fmt.subformat[0],this.uInt32),l(this.fmt.subformat[1],this.uInt32),l(this.fmt.subformat[2],this.uInt32),l(this.fmt.subformat[3],this.uInt32))),s}getLISTBytes_(){let s=[];for(let t=0;t<this.LIST.length;t++){let e=this.getLISTSubChunksBytes_(this.LIST[t].subChunks,this.LIST[t].format);s=s.concat(b(this.LIST[t].chunkId),l(e.length+4,this.uInt32),b(this.LIST[t].format),e)}return this.enforceByteLen_(s),s}getLISTSubChunksBytes_(s,t){let e=[];for(let n=0,i=s.length;n<i;n++)t=="INFO"?e=e.concat(this.getLISTINFOSubChunksBytes_(s[n])):t=="adtl"&&(e=e.concat(this.getLISTadtlSubChunksBytes_(s[n]))),this.enforceByteLen_(e);return e}getLISTINFOSubChunksBytes_(s){let t=[],e=v(s.value,s.value.length);return t=t.concat(b(s.chunkId),l(e.length+1,this.uInt32),e),t.push(0),t}getLISTadtlSubChunksBytes_(s){let t=[];if(["labl","note"].indexOf(s.chunkId)>-1){let e=v(s.value,s.value.length);t=t.concat(b(s.chunkId),l(e.length+4+1,this.uInt32),l(s.dwName,this.uInt32),e),t.push(0)}else s.chunkId=="ltxt"&&(t=t.concat(this.getLtxtChunkBytes_(s)));return t}getLtxtChunkBytes_(s){return[].concat(b(s.chunkId),l(s.value.length+20,this.uInt32),l(s.dwName,this.uInt32),l(s.dwSampleLength,this.uInt32),l(s.dwPurposeID,this.uInt32),l(s.dwCountry,this.uInt16),l(s.dwLanguage,this.uInt16),l(s.dwDialect,this.uInt16),l(s.dwCodePage,this.uInt16),v(s.value,s.value.length))}get_PMXBytes_(){let s=[];if(this._PMX.chunkId){let t=b(this._PMX.value);this._PMX.chunkSize=t.length,s=s.concat(b(this._PMX.chunkId),l(this._PMX.chunkSize,this.uInt32),t)}return this.enforceByteLen_(s),s}getJunkBytes_(){let s=[];return this.junk.chunkId?s.concat(b(this.junk.chunkId),l(this.junk.chunkData.length,this.uInt32),this.junk.chunkData):(this.enforceByteLen_(s),s)}enforceByteLen_(s){s.length%2&&s.push(0)}}function Ot(o){let s=[];if(o.length>0)if(o[0].constructor!==Number){s=new Float64Array(o[0].length*o.length);for(let t=0,e=o[0].length,n=0;t<e;t++)for(let i=0,r=o.length;i<r;i++,n++)s[n]=o[i][t]}else s=o;return s}function Ut(o,s,t=Float64Array){let e=[];for(let n=0;n<s;n++)e[n]=new t(o.length/s);for(let n=0;n<s;n++)for(let i=n,r=0;i<o.length;i+=s,r++)e[n][r]=o[i];return e}function Ht(o,s){let t=o*s/8;return!(o<1||t>65535)}function Xt(o,s,t){let e=o*(s/8)*t;return!(t<1||e>4294967295)}class gt extends Bt{constructor(){super();a(this,"bitDepth");a(this,"dataType");a(this,"WAV_AUDIO_FORMATS");this.bitDepth="0",this.dataType={bits:0,be:!1},this.WAV_AUDIO_FORMATS={4:17,8:1,"8a":6,"8m":7,16:1,24:1,32:1,"32f":3,64:3}}fromScratch(t,e,n,i,r){r=r||{},this.clearHeaders(),this.newWavFile_(t,e,n,i,r)}fromBuffer(t,e=!0){super.fromBuffer(t,e),this.bitDepthFromFmt_(),this.updateDataType_()}toBuffer(){return this.validateWavHeader_(),super.toBuffer()}getSamples(t=!1,e=Float64Array){let n=new e(this.data.samples.length/(this.dataType.bits/8));return pt(this.data.samples,this.dataType,n,0,this.data.samples.length),!t&&this.fmt.numChannels>1?Ut(n,this.fmt.numChannels,e):n}getSample(t){if(t=t*(this.dataType.bits/8),t+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");return F(this.data.samples.slice(t,t+this.dataType.bits/8),this.dataType)}setSample(t,e){if(t=t*(this.dataType.bits/8),t+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");q(e,this.dataType,this.data.samples,t)}getiXML(){return this.iXML.value}setiXML(t){if(typeof t!="string")throw new TypeError("iXML value must be a string.");this.iXML.value=t,this.iXML.chunkId="iXML"}get_PMX(){return this._PMX.value}set_PMX(t){if(typeof t!="string")throw new TypeError("_PMX value must be a string.");this._PMX.value=t,this._PMX.chunkId="_PMX"}newWavFile_(t,e,n,i,r){r.container||(r.container="RIFF"),this.container=r.container,this.bitDepth=n,i=Ot(i),this.updateDataType_();let c=this.dataType.bits/8;this.data.samples=new Uint8Array(i.length*c),dt(i,this.dataType,this.data.samples,0),this.makeWavHeader_(n,t,e,c,this.data.samples.length,r),this.data.chunkId="data",this.data.chunkSize=this.data.samples.length,this.validateWavHeader_()}makeWavHeader_(t,e,n,i,r,c){t=="4"?this.createADPCMHeader_(t,e,n,i,r,c):t=="8a"||t=="8m"?this.createALawMulawHeader_(t,e,n,i,r,c):Object.keys(this.WAV_AUDIO_FORMATS).indexOf(t)==-1||e>2?this.createExtensibleHeader_(t,e,n,i,r,c):this.createPCMHeader_(t,e,n,i,r,c)}createPCMHeader_(t,e,n,i,r,c){this.container=c.container,this.chunkSize=36+r,this.format="WAVE",this.bitDepth=t,this.fmt={chunkId:"fmt ",chunkSize:16,audioFormat:this.WAV_AUDIO_FORMATS[t]||65534,numChannels:e,sampleRate:n,byteRate:e*i*n,blockAlign:e*i,bitsPerSample:parseInt(t,10),cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]}}createADPCMHeader_(t,e,n,i,r,c){this.createPCMHeader_(t,e,n,i,r,c),this.chunkSize=40+r,this.fmt.chunkSize=20,this.fmt.byteRate=4055,this.fmt.blockAlign=256,this.fmt.bitsPerSample=4,this.fmt.cbSize=2,this.fmt.validBitsPerSample=505,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:r*2}}createExtensibleHeader_(t,e,n,i,r,c){this.createPCMHeader_(t,e,n,i,r,c),this.chunkSize=60+r,this.fmt.chunkSize=40,this.fmt.bitsPerSample=(parseInt(t,10)-1|7)+1,this.fmt.cbSize=22,this.fmt.validBitsPerSample=parseInt(t,10),this.fmt.dwChannelMask=Wt(e),this.fmt.subformat=[1,1048576,2852126848,1905997824]}createALawMulawHeader_(t,e,n,i,r,c){this.createPCMHeader_(t,e,n,i,r,c),this.chunkSize=40+r,this.fmt.chunkSize=20,this.fmt.cbSize=2,this.fmt.validBitsPerSample=8,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:r}}bitDepthFromFmt_(){this.fmt.audioFormat===3&&this.fmt.bitsPerSample===32?this.bitDepth="32f":this.fmt.audioFormat===6?this.bitDepth="8a":this.fmt.audioFormat===7?this.bitDepth="8m":this.bitDepth=this.fmt.bitsPerSample.toString()}validateBitDepth_(){if(!this.WAV_AUDIO_FORMATS[this.bitDepth]){if(parseInt(this.bitDepth,10)>8&&parseInt(this.bitDepth,10)<54)return!0;throw new Error("Invalid bit depth.")}return!0}updateDataType_(){this.dataType={bits:(parseInt(this.bitDepth,10)-1|7)+1,fp:this.bitDepth=="32f"||this.bitDepth=="64",signed:this.bitDepth!="8",be:this.container=="RIFX"},["4","8a","8m"].indexOf(this.bitDepth)>-1&&(this.dataType.bits=8,this.dataType.signed=!1)}validateWavHeader_(){if(this.validateBitDepth_(),!Ht(this.fmt.numChannels,this.fmt.bitsPerSample))throw new Error("Invalid number of channels.");if(!Xt(this.fmt.numChannels,this.fmt.bitsPerSample,this.fmt.sampleRate))throw new Error("Invalid sample rate.")}}function Wt(o){let s=0;return o===1?s=4:o===2?s=3:o===4?s=51:o===6?s=63:o===8&&(s=1599),s}async function jt(o){const s=()=>new Promise(i=>setTimeout(i,0));let t=0,e=0,n=0;for(;t===0||e===0;)if(await s(),t=o.parentElement.offsetWidth,e=o.parentElement.offsetHeight,n++,n>100){console.log("Cannot get canvas container size");break}return[t,e]}async function B(o){const s=()=>new Promise(i=>setTimeout(i,0)),t=o.style.display;o.style.display="none",await s();const[e,n]=await jt(o);o.width=e-1,o.height=n-1,o.style.display=t,console.log("DISPTCHEN",o),o.dispatchEvent(new CustomEvent("resize"))}function O(o,s,t,e){const n=t?t.start:0,r=(t?t.end:e)-n,c=s/o.width;return n+Math.floor(c*r)}function ft(o){return o*parseFloat(getComputedStyle(document.documentElement).fontSize)}function Z(o,s,t,e,n,i,r,c,u){o.fillStyle=u,o.globalAlpha=.5;const d=i?i.start:0,w=(i?i.end:c)-d,y=(r.start-d)/w*e,M=(r.end-d)/w*e;o.fillRect(s+y,t,M-y,n)}function wt(o,s,t,e,n,i,r,c,u,d){o.fillStyle=u||"#000",o.globalAlpha=1,o.fillRect(s,t,e,n);const g=i?i.start:0,y=(i?i.end:c.length)-g,M=y/e;let x=g;o.beginPath(),o.moveTo(s,t+n/2);for(let C=0;C<e;C++){const X=Math.floor(x),vt=c[X];o.lineTo(s+C,t+n/2+vt*n),x+=M}o.strokeStyle=d,o.stroke();const S=(r-g)/y*e;o.strokeStyle="#0F0",o.globalAlpha=1,o.beginPath(),o.moveTo(s+S,t),o.lineTo(s+S,t+n),o.stroke()}class Gt extends f{constructor(){super(...arguments);a(this,"canvas");a(this,"mouseDown",!1);a(this,"selectionStart",0);a(this,"selectionEnd",0);a(this,"onResize",async()=>{console.log("window resize"),await B(this.canvas),this.redrawCanvas()});a(this,"onMouseDown",t=>{console.log("ITS A DOWN"),this.mouseDown||(this.selectionStart!==this.selectionEnd&&this.dispatch(this.props,"select",null),this.mouseDown=!0,this.selectionStart=O(this.canvas,t.offsetX,this.props.zoom,this.props.buffers[0].length))});a(this,"onMouseUp",t=>{this.mouseDown&&(this.mouseDown=!1)});a(this,"onMouseMove",t=>{if(!this.mouseDown)return;this.selectionEnd=O(this.canvas,t.offsetX,this.props.zoom,this.props.buffers[0].length);const e={start:Math.min(this.selectionStart,this.selectionEnd),end:Math.max(this.selectionStart,this.selectionEnd)};this.dispatch(this.props,"select",e)})}async mounted(t){if(console.log("MOUNTING CANVASSSSSSSSSSSSSSSSSSSSSSSSSSSSSS"),!(t instanceof HTMLElement))throw new Error("Unexpected canvas host");this.canvas=t.querySelector("canvas"),window.addEventListener("resize",this.onResize),await B(this.canvas),this.redrawCanvas()}unMounted(){window.removeEventListener("resize",this.onResize)}drawBuffer(t,e,n,i,r,c,u){t.fillStyle="#000",t.strokeStyle="#FFF",t.globalAlpha=1,t.fillRect(e,n,i,r);const d=c?c.start:0,g=c?c.end:u.length,w=g-d,y=w/i;let M=d;console.log("Drawing wave buffer",d,g,y),t.beginPath(),t.moveTo(e,n+r/2);for(let S=0;S<i;S++){const C=Math.floor(M),X=u[C];t.lineTo(e+S,n+r/2+X*r),M+=y}if(t.strokeStyle="#fff",t.stroke(),t.fillStyle="#fff",t.globalAlpha=.5,this.props.selection){const S=(this.props.selection.start-d)/w*i,C=(this.props.selection.end-d)/w*i;t.fillRect(e+S,n,C-S,r)}const x=(this.props.playPosition-d)/w*i;t.strokeStyle="#0F0",t.globalAlpha=1,t.beginPath(),t.moveTo(e+x,n),t.lineTo(e+x,n+r),t.stroke()}redrawCanvas(){const t=this.canvas.getContext("2d"),e=this.props.buffers.length,n=ft(.25);let i;e>1?i=(this.canvas.height-(e-1)*n)/e:i=this.canvas.height;for(let r=0;r<e;r++)wt(t,0,n*r+i*r,this.canvas.width,i,this.props.zoom,this.props.playPosition,this.props.buffers[0],"#000","#fff"),this.props.selection&&Z(t,0,n*r+i*r,this.canvas.width,i,this.props.zoom,this.props.selection,this.props.buffers[0].length,"#FFF")}render(){return this.watch(this.props,"buffers",async()=>{this.redrawCanvas()}),this.watch(this.props,"selection",()=>{this.redrawCanvas()}),this.watch(this.props,"zoom",()=>{this.redrawCanvas()}),this.watch(this.props,"playPosition",async()=>{this.redrawCanvas()}),[new h("div",{className:"flex-1 w-full pb-1",content:()=>[new h("canvas",{className:"rounded-lg",mousedown:t=>this.onMouseDown(t),mouseup:this.onMouseUp,mousemove:this.onMouseMove})]})]}}function j(o,s){const[t,e]=o,[n,i,r,c]=s;return t>=n&&t<r&&e>=i&&e<c}class Vt extends f{constructor(){super(...arguments);a(this,"canvas");a(this,"mouseDown",!1);a(this,"selectionStart",0);a(this,"selectionEnd",0);a(this,"onResize",async()=>{console.log("window resize"),await B(this.canvas),this.updateRects(),this.redrawCanvas()});a(this,"onMouseDown",t=>{console.log("ITS A DOWN"),this.mouseDown||(t.shiftKey,this.selectionStart!==this.selectionEnd&&this.dispatch(this.props,"select",null),this.mouseDown=!0,this.selectionStart=O(this.canvas,t.offsetX,null,this.props.buffers[0].length))});a(this,"onMouseUp",t=>{this.mouseDown&&(this.mouseDown=!1)});a(this,"onMouseMove",t=>{if(this.zoomRect&&j([t.offsetX,t.offsetY],this.zoomRect)?(console.log("WE MOVE MOSE AAND ITS IN RECT"),this.canvas.style.cursor="move"):this.zoomHandleLeftRect&&j([t.offsetX,t.offsetY],this.zoomHandleLeftRect)?(console.log("LEFT RECT"),this.canvas.style.cursor="ew-resize"):this.zoomHandleRightRect&&j([t.offsetX,t.offsetY],this.zoomHandleRightRect)?(console.log("RIGHT RECT"),this.canvas.style.cursor="ew-resize"):this.canvas.style.cursor="default",!this.mouseDown)return;this.selectionEnd=O(this.canvas,t.offsetX,null,this.props.buffers[0].length);const e={start:Math.min(this.selectionStart,this.selectionEnd),end:Math.max(this.selectionStart,this.selectionEnd)};this.dispatch(this.props,"select",e)});a(this,"zoomRect",null);a(this,"zoomHandleLeftRect",null);a(this,"zoomHandleRightRect",null)}updateRects(){if(this.props.zoom){const t=this.props.zoom,e=t?t.start:0,n=t?t.end:this.props.buffers[0].length,i=n-e,r=this.props.buffers[0].length;console.log("ZOOM OF ",i,this.canvas.width,e,n),this.zoomRect=[e/r*this.canvas.width+2,0,n/r*this.canvas.width-2,this.canvas.height],this.zoomHandleLeftRect=[e/r*this.canvas.width-2,0,e/r*this.canvas.width+2,this.canvas.height],this.zoomHandleRightRect=[n/r*this.canvas.width-2,0,n/r*this.canvas.width+2,this.canvas.height]}else this.zoomRect=null,this.zoomHandleLeftRect=null,this.zoomHandleRightRect=null;console.log("ZOOM RECT IS",this.zoomRect)}async mounted(t){if(!(t instanceof HTMLElement))throw new Error("Unexpected canvas host");this.canvas=t.querySelector("canvas"),window.addEventListener("resize",this.onResize),this.watch(this.props,"zoom",()=>{this.updateRects()}),await B(this.canvas),this.updateRects(),this.redrawCanvas()}unMounted(){window.removeEventListener("resize",this.onResize)}redrawCanvas(){const t=this.canvas.getContext("2d"),e=this.props.buffers.length,n=ft(.25);let i;e>1?i=(this.canvas.height-(e-1)*n)/e:i=this.canvas.height;for(let r=0;r<e;r++)wt(t,0,n*r+i*r,this.canvas.width,i,null,this.props.playPosition,this.props.buffers[0],"#112","#fff"),this.props.zoom&&Z(t,0,n*r+i*r,this.canvas.width,i,null,this.props.zoom,this.props.buffers[0].length,"#000"),this.props.selection&&Z(t,0,n*r+i*r,this.canvas.width,i,null,this.props.selection,this.props.buffers[0].length,"#FFF")}render(){return this.watch(this.props,"buffers",async()=>{this.redrawCanvas()}),this.watch(this.props,"selection",()=>{this.redrawCanvas()}),this.watch(this.props,"zoom",()=>{this.redrawCanvas()}),this.watch(this.props,"playPosition",async()=>{this.redrawCanvas()}),[new h("div",{className:"h-36 w-full",content:()=>[new h("canvas",{className:"rounded-lg",pointerdown:t=>this.onMouseDown(t),pointerup:this.onMouseUp,pointermove:this.onMouseMove})]})]}}async function Zt(){const o=await navigator.clipboard.read();let s;for(let r of o)if(s=await r.getType("web audio/wav"),s)break;const t=await s.arrayBuffer();var e=new Uint8Array(t);console.log("reading",e);const n=new gt;return n.fromBuffer(e,!0),{id:0,buffers:n.getSamples(!0,Float32Array),sampleRate:48e3}}async function et(o){const s=new gt;s.fromScratch(o.buffers.length,o.sampleRate,"32f",o.buffers);const t=s.toBuffer();console.log("WRITING",t);const e=new Blob([t],{type:"audio/wav"}),n=[new ClipboardItem({"web audio/wav":e})];await navigator.clipboard.write(n)}class I extends f{render(){return[new h("button",{className:"flex flex-row gap-1 font-bold p-1 px-2 rounded-lg text-neutral-300 bg-neutral-600 hover:bg-neutral-500 disabled:bg-neutral-700 disabled:text-neutral-400",disabled:()=>this.props.disabled,content:()=>this.props.content,click:s=>this.dispatch(this.props,"click",s)})]}}class L extends f{render(){return[new h("div",{className:"flex flex-row pb-1 gap-1",content:()=>this.props.content})]}}class qt extends f{constructor(t,e){super(t);a(this,"document");a(this,"onPlay",()=>{this.dispatch(this.props,"play",this)});a(this,"onRecord",()=>{this.dispatch(this.props,"record",this)});a(this,"onCrop",()=>{console.log("CROP USING, ",this.props.selection),this.document.crop(this.props.selection.start,this.props.selection.end)});a(this,"onCopy",async()=>{const t=await this.document.createRecordingFromRange(this.props.selection.start,this.props.selection.end);await et(t)});a(this,"onCut",async()=>{const t=await this.document.deleteRange(this.props.selection.start,this.props.selection.end);this.document.commit("Cut"),await et(t)});a(this,"onPaste",async()=>{const t=await Zt();console.log("CLIP HAS",t),this.document.replaceRange(this.props.selection.start,t)});a(this,"onUndo",()=>{this.document.undo()});a(this,"onRedo",()=>{this.document.redo()});a(this,"onZoom",()=>{this.document.setZoom(this.props.selection)});a(this,"onUpdateFromDocument",()=>{console.log("Document changed",this.document.selection),this.props.historyPosition=this.document.document.historyPosition,this.props.playPosition=this.document.playPosition,this.props.selection=this.document.selection?{...this.document.selection}:null,this.props.zoom=this.document.zoom?{...this.document.zoom}:null,this.props.recordingName=this.document.document.name,this.props.buffers=this.document.recording.buffers});this.document=e,this.onUpdateFromDocument()}mounted(){console.log("IS IT MOUNTING?? WHY NOT THE CGHILD NODERS",this),this.document.addEventListener("change",this.onUpdateFromDocument)}unMounted(){this.document.removeEventListener("change",this.onUpdateFromDocument)}render(){return[new L({content:[new I({content:[new h("span",{className:"hgi-stroke hgi-copy-01"}),new p("Copy")],click:this.onCopy,disabled:()=>!this.props.selection}),new I({content:[new h("span",{className:"hgi-stroke hgi-scissor-01"}),new p("Cut")],click:this.onCut,disabled:()=>!this.props.selection}),new I({content:[new h("span",{className:"hgi-stroke hgi-column-insert"}),new p("Paste")],click:this.onPaste,disabled:()=>!1}),new I({content:[new h("span",{className:"hgi-stroke hgi-crop"}),new p("Crop")],click:this.onCrop,disabled:()=>!this.props.selection}),new h("div",{className:"p-1"}),new I({content:[new h("span",{className:"hgi-stroke hgi-arrow-left-double"}),new p("Undo")],click:this.onUndo,disabled:()=>this.props.historyPosition==0}),new I({content:[new h("span",{className:"hgi-stroke hgi-arrow-right-double"}),new p("Redo")],click:this.onRedo,disabled:()=>this.props.historyPosition>=this.document.document.history.length-1}),new I({content:[new h("span",{className:"hgi-stroke hgi-zoom-in-area"}),new p("Zoom")],click:this.onZoom,disabled:()=>!this.props.selection&&!this.props.zoom}),new I({content:[new h("span",{className:"hgi-stroke hgi-zoom-in-area"}),new p("+")],click:this.onCrop,disabled:()=>!1}),new I({content:[new h("span",{className:"hgi-stroke hgi-zoom-in-area"}),new p("-")],click:this.onCrop,disabled:()=>!1}),new I({content:[new h("span",{className:"hgi-stroke hgi-next"}),new p("Play")],click:this.onPlay}),new I({content:()=>[new h("span",{className:"hgi-stroke hgi-record"}),new p("Record")],click:this.onRecord})]}),new Gt({buffers:()=>this.props.buffers,playPosition:()=>this.props.playPosition,selection:()=>this.props.selection,zoom:()=>this.props.zoom,select:t=>{console.log("ITS A SELECT"),this.document.setSelection(t)}}),new Vt({buffers:()=>this.props.buffers,playPosition:()=>this.props.playPosition,selection:()=>this.props.selection,zoom:()=>this.props.zoom,select:t=>{console.log("ITS A SELECT"),this.document.setSelection(t)}})]}}class Yt extends f{constructor(){super(...arguments);a(this,"onConfirm",()=>{this.dispatch(this.props,"confirm",{inputDeviceId:this.props.currentInputDeviceId,outputDeviceId:this.props.currentOutputDeviceId,inputMode:this.props.inputMode})});a(this,"refresh",()=>{this.dispatch(this.props,"refresh")});a(this,"onChangeInputDevice",t=>{this.props.currentInputDeviceId=t.target.value,this.dispatchChangeDevice()});a(this,"onChangeOutputDevice",t=>{this.props.currentOutputDeviceId=t.target.value,this.dispatchChangeDevice()})}async mounted(){this.dispatchChangeDevice()}dispatchChangeDevice(){this.dispatch(this.props,"change",{inputDeviceId:this.props.currentInputDeviceId,outputDeviceId:this.props.currentOutputDeviceId,inputMode:this.props.inputMode})}renderPrompt(){return new h("div",{content:()=>new p("Please allow to use your microphone")})}renderDismissed(){return new h("div",{content:()=>[new p("Please allow to use your microphone"),new h("button",{content:()=>[new p("Retry")],click:()=>this.refresh()})]})}renderDenied(){return console.log("RENDER DENIED"+this.props.microphonePermission),new h("div",{content:()=>new p("Your microphone is blocked.")})}renderForm(){return new h("div",{className:"",content:()=>[new T({label:"Output Device",input:[new h("select",{className:"w-full rounded-lg p-1 bg-neutral-800",value:()=>this.props.currentOutputDeviceId,content:()=>[new N({items:()=>this.props.outputDevices,itemCallback:t=>new h("option",{value:t.value,content:()=>new p(t.text)})})],change:this.onChangeOutputDevice})]}),new T({label:"Input Device",input:()=>[new h("select",{className:"w-full rounded-lg p-1 bg-neutral-800",value:()=>this.props.currentInputDeviceId,content:()=>[new N({items:()=>this.props.inputDevices,itemCallback:t=>new h("option",{value:t.value,content:()=>[new p(t.text)]})})],change:this.onChangeInputDevice}),new h("div",{className:"text-xs",content:()=>[new p(()=>"Sample Rate: "+this.props.currentInputSampleRate+"hz, Channels: "+this.props.currentInputChannelCount)]})]}),new ht({label:"Record Channels",name:"recordingChannels",value:()=>this.props.inputMode,items:[{text:"Stereo",value:"stereo"},{text:"Left only",value:"left"},{text:"Right only",value:"right"}],change:t=>{this.props.inputMode=t,console.log("Radio",t)}}),new L({content:[new I({content:()=>[new p("Refresh")],click:()=>this.refresh()}),new I({content:()=>[new p("OK")],click:()=>this.onConfirm()})]})]})}render(){return[new H(()=>this.props.microphonePermission==="prompt"?this.renderPrompt():this.props.microphonePermission==="dismissed"?this.renderDismissed():this.props.microphonePermission==="denied"?this.renderDenied():this.renderForm())]}}class Jt extends f{constructor(t,e){super(t);a(this,"storage");a(this,"onStorageChanged",()=>{this.refreshFromStorage()});this.storage=e}async refreshFromStorage(){console.log("GET STORED RECORDINGS",this.storage);const t=await this.storage.getAll();console.log("STORED RECORDINGS",t),this.props.recordings=t}async mounted(){this.storage.addEventListener("create-document",this.onStorageChanged),this.storage.addEventListener("update-document",this.onStorageChanged),await this.refreshFromStorage()}unmounted(){this.storage.removeEventListener("create-document",this.onStorageChanged),this.storage.removeEventListener("update-document",this.onStorageChanged)}render(){return console.log("RENDERING RECORDINGSPANEL!"),[new L({content:[new I({content:[new h("span",{className:"hgi-stroke hgi-plus-sign-square"}),new p("New...")],click:t=>this.dispatch(this.props,"createNew",t)}),new I({content:[new h("span",{className:"hgi-stroke hgi-mic-01"}),new p("Device...")],click:t=>this.dispatch(this.props,"device",t)}),new I({content:[new h("span",{className:"hgi-stroke hgi-refresh"})],click:t=>this.refreshFromStorage()})]}),new Qt({recordings:()=>this.props.recordings,select:t=>this.dispatch(this.props,"select",t)})]}}function Kt(o){const s=Math.floor(o/60);return o-=s*60,s+"m "+Math.floor(o)+"s"}class Qt extends f{render(){const s=t=>{this.dispatch(this.props,"select",t)};return[new h("div",{className:"h-full w-full rounded-lg rounded-lg bg-neutral-600 p-1 overflow-auto",content:()=>[new h("table",{width:"100%",content:()=>[new h("tr",{content:()=>[new h("td",{content:()=>[new p("Name")]}),new h("td",{content:()=>[new p("Duration")]}),new h("td",{content:()=>[new p("Sample Rate")]})]}),new N({items:()=>this.props.recordings,itemCallback:t=>new h("tr",{className:"hover:bg-neutral-400",content:()=>[new h("td",{className:"whitespace-nowrap",content:()=>[new p(t.name)]}),new h("td",{content:()=>[new p(Kt(t.sampleCount/t.sampleRate))]}),new h("td",{content:()=>[new p(t.sampleRate/1e3+"khz")]})],click:()=>s(t)})})]})]})]}}async function P(o){return await new Promise((s,t)=>{o.onsuccess=()=>{s(o.result)},o.onerror=()=>{t(new Error("Add failed"))}})}class $t{constructor(s){this.index=s}async getAll(s,t){const e=this.index.getAll(s,t);return await P(e)}}class te{constructor(s){this.objectStore=s}get name(){return this.objectStore.name}get keyPath(){return this.objectStore.keyPath}async add(s,t){const e=this.objectStore.add(s,t);return await P(e)}async put(s,t){const e=this.objectStore.put(s,t);return await P(e)}async getAll(s,t){const e=this.objectStore.getAll(s,t);return await P(e)}async get(s,t){const e=this.objectStore.get(s);return await P(e)}index(s){return new $t(this.objectStore.index(s))}}class ee{constructor(s,t,e){a(this,"name");a(this,"schema");a(this,"version");a(this,"db");this.name=s,this.schema=t,e&&(this.version=e),this.db=null,Object.seal(this)}open(){return new Promise((s,t)=>{const e=self.indexedDB.open(this.name,this.version),n=this.schema;e.onerror=i=>t(i),e.onsuccess=i=>{this.db=e.result,s(this)},e.onupgradeneeded=function(i){n(this.result)}})}query(s,t="readwrite"){const n=this.db.transaction(s,t).objectStore(s);return new te(n)}async clear(){return new Promise((s,t)=>{const e=self.indexedDB.deleteDatabase(this.name);e.onsuccess=s,e.onerror=t})}}class se extends EventTarget{constructor(){super();a(this,"db");this.db=null}async open(){const t=e=>{console.log("UPGRADE DB");for(let n of e.objectStoreNames)console.log("DELETE DB"+n),e.deleteObjectStore(n);e.createObjectStore("documents",{keyPath:"id",autoIncrement:!0}),e.createObjectStore("recordings",{keyPath:"id",autoIncrement:!0})};this.db=new ee("AudioStorage",t,6),await this.db.open()}async getAll(){return await this.db.query("documents").getAll()}async getWaveDocument(t){return await this.db.query("documents").get(t)}async getRecording(t){return await this.db.query("recordings").get(t)}async createRecording(t){const n=await this.db.query("recordings").add(t);return this.dispatchEvent(new CustomEvent("create-recording",{detail:n})),n}async updateRecording(t){const n=await this.db.query("recordings").put(t);return this.dispatchEvent(new CustomEvent("update-recording",{detail:n})),n}async createDocument(t){const n=await this.db.query("documents").add(t);return this.dispatchEvent(new CustomEvent("create-document",{detail:n})),n}async updateDocument(t){const n=await this.db.query("documents").put(t);return this.dispatchEvent(new CustomEvent("update-recording",{detail:n})),n}}class ne extends f{render(){const s=()=>{this.dispatch(this.props,"createNew",this.props)},t=()=>{this.dispatch(this.props,"cancel")};return[new T({label:"Name",input:[new h("input",{className:"w-full rounded-lg p-1 bg-neutral-800",value:()=>this.props.name,type:"text",change:e=>this.props.name=e.target.value})]}),new T({label:"Duration (sec)",input:[new h("input",{className:"text-right w-20 rounded-lg p-1 bg-neutral-800",value:()=>this.props.durationSec.toString(),type:"number",size:8,change:e=>this.props.durationSec=parseInt(e.target.value)}),new h("div",{className:"text-xs",content:()=>[new p(()=>"Sample Rate: "+this.props.sampleRate+"hz")]})]}),new ht({label:"Channels",name:"recordingChannels",value:()=>this.props.channelCount==2?"stereo":"mono",items:[{text:"Stereo",value:"stereo"},{text:"Mono",value:"mono"}],change:e=>{this.props.channelCount=e=="stereo"?2:1,console.log("Radio",e)}}),new L({content:[new I({content:[new p("Create")],click:e=>s()}),new I({content:[new p("Cancel")],click:e=>t()})]})]}}const E=8192*4;function st(){return[new Float32Array(E),new Float32Array(E)]}class ie extends EventTarget{constructor(t){super();a(this,"context");a(this,"recordNode");this.context=t,this.recordNode=this.setupRecordNode(),this.recordNode.connect(t.destination)}setupRecordNode(){const t=new AudioWorkletNode(this.context,"record-processor");let e=st(),n=0;return t.port.onmessage=async i=>{const r=i.data,c=r[0].length;if(c>E)throw new Error("Recorder buffer size too small");let u=c,d=0;for(;u>0;){const g=Math.min(E-n,u);for(let w=0;w<e.length;w++)e[w].set(r[w%r.length].subarray(d,d+g),n);d+=g,n===E?(this.dispatchEvent(new CustomEvent("input",{detail:e})),e=st(),n=0,u-=g):(n+=g,u-=g)}},t}}class oe{constructor(){a(this,"context");a(this,"inputNode");a(this,"recorder");a(this,"inputMode");this.inputMode="stereo"}async create(s,t){this.context=new AudioContext({sinkId:s});const e=new URL("data:text/javascript;base64,Y2xhc3MgUmVjb3JkUHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsNCiAgY29uc3RydWN0b3IoKSB7DQogICAgc3VwZXIoKTsNCiAgICAvLyB0aGlzLnBvcnQuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIChlKSA9PiB7DQogICAgLy8gICBjb25zb2xlLmxvZygibWVzc2FnZSBmcm9tIGhvc3QiLCBlKTsNCiAgICAvLyB9KTsNCiAgfQ0KDQogIHByb2Nlc3MoaW5wdXRzLCBvdXRwdXRzLCBwYXJhbWV0ZXJzKSB7DQogICAgLy8gaW5wdXRzOiBBbiBhcnJheSBvZiBpbnB1dHMgY29ubmVjdGVkIHRvIHRoZSBub2RlLCBlYWNoIGl0ZW0gb2Ygd2hpY2ggaXMsIGluIHR1cm4sIGFuIGFycmF5IG9mIGNoYW5uZWxzLiANCiAgICBpZiAoIWlucHV0cy5sZW5ndGgpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIC8vIFJlY29yZCB1cCB0byB0d28gY2hhbm5lbHMgZnJvbSB0aGUgZmlyc3QgaW5wdXQsIGFzc3VtZSBvbmx5IGEgbWljcm9waG9uZSBzdHJlYW0gaXMgY29ubmVjdGVkDQogICAgY29uc3QgaW5wdXRCdWZmZXJzID0gaW5wdXRzWzBdOw0KICAgIHRoaXMucG9ydC5wb3N0TWVzc2FnZShpbnB1dEJ1ZmZlcnMpOw0KICAgIHJldHVybiB0cnVlOw0KICB9DQp9DQoNCnJlZ2lzdGVyUHJvY2Vzc29yKCJyZWNvcmQtcHJvY2Vzc29yIiwgUmVjb3JkUHJvY2Vzc29yKTsNCg==",import.meta.url);console.log("WORKLET URL",e),await this.context.audioWorklet.addModule(e);const n=await navigator.mediaDevices.getUserMedia({audio:{advanced:[{deviceId:t}]},video:!1});this.inputNode=this.context.createMediaStreamSource(n),this.recorder=new ie(this.context),this.inputNode.connect(this.recorder.recordNode)}async close(){this.inputNode.disconnect(this.recorder.recordNode),await this.context.close(),this.context=null,this.inputNode=null}}class re{constructor(s){a(this,"document");this.document=s}async insertRange(s){const t=await this.document.storage.getRecording(s.bufferRecordingId),e=t.buffers[0].length,n=this.document.recording.buffers[0].length,i=this.document.recording.buffers.map(c=>new Float32Array(n+e)),r=s.rangeStart;for(let c=0;c<i.length;c++){const u=i[c],d=this.document.recording.buffers[c],g=t.buffers[c%t.buffers.length];u.set(d.subarray(0,r),0),u.set(g,r),u.set(d.subarray(r),r+g.length)}console.log("Updating after insert"),this.document.document.sampleCount=n+e,this.document.recording.buffers=i}async deleteRange(s){const t=s.rangeStart,e=s.rangeEnd,n=e-t,i=this.document.recording.buffers[0].length,r=this.document.recording.buffers.map(c=>new Float32Array(i-n));for(let c=0;c<r.length;c++){const u=r[c],d=this.document.recording.buffers[c];u.set(d.subarray(0,t),0),u.set(d.subarray(e),t)}console.log("Updating after delete"),this.document.document.sampleCount=i-n,this.document.recording.buffers=r}async replaceRange(s){const t=await this.document.storage.getRecording(s.bufferRecordingId),e=s.rangeStart,n=this.document.recording.buffers;console.log(s,n,t);for(let i=0;i<n.length;i++){const r=n[i],c=t.buffers[i%t.buffers.length];r.set(c,e)}}}class J extends EventTarget{constructor(t,e,n,i){super();a(this,"device");a(this,"storage");a(this,"document");a(this,"recording");a(this,"manipulator");a(this,"operation");a(this,"selection");a(this,"zoom");a(this,"playPosition",0);a(this,"isRecording");a(this,"onRecordInput",async t=>{const e=t.detail,n=this.recording.buffers,i=e[0].length,r=n[0].length;if(this.playPosition+i>r){console.log("Recorder reached end of output buffer"),this.stopRecording();return}const c=await this.storage.createRecording({buffers:e,sampleRate:44100}),u=await this.storage.getRecording(c);console.log("THEY SAID UNDEFINED",c,u),await this.replaceRange(this.playPosition,u),this.playPosition+=i,this.dispatchEvent(new CustomEvent("change"))});this.device=t,this.storage=e,this.document=n,this.recording=i,this.manipulator=new re(this),this.operation={label:"",redo:[],undo:[]}}static createFromBuffers(t,e,n,i,r){return new J(t,e,{id:0,name:n,channelCount:r.length,sampleRate:i,sampleCount:r[0].length,historyPosition:0,history:[],recordingId:0},{id:0,sampleRate:i,buffers:r})}async createRecordingFromRange(t,e){const n=await this.storage.createRecording({sampleRate:this.recording.sampleRate,buffers:this.recording.buffers.map(i=>i.subarray(t,e))});return console.log("CREATED RECORDING",n),await this.storage.getRecording(n)}async crop(t,e){await this.deleteRange(e,this.document.sampleCount),await this.deleteRange(0,t),await this.commit("Crop"),this.dispatchEvent(new CustomEvent("change",{detail:this}))}setPlayPosition(t){this.playPosition=t,this.dispatchEvent(new CustomEvent("change",{detail:this}))}setSelection(t){this.selection=t,this.dispatchEvent(new CustomEvent("change",{detail:this}))}setZoom(t){this.zoom=t,this.dispatchEvent(new CustomEvent("change",{detail:this}))}async redo(){if(this.document.historyPosition>=this.document.history.length-1)return;if(this.operation.redo.length||this.operation.undo.length)throw new Error("Should not redo in an active operation");this.document.historyPosition++;const t=this.document.history[this.document.historyPosition];console.log("redoing",t),console.log(this.recording.buffers);for(let e of t.redo)await this.execAction(e);this.dispatchEvent(new CustomEvent("change",{detail:this}))}async undo(){if(this.document.historyPosition<=0)return;if(this.operation.redo.length||this.operation.undo.length)throw new Error("Should not undo in an active operation");const t=this.document.history[this.document.historyPosition];console.log("undoing",t),console.log(this.recording.buffers),this.document.historyPosition--;const e=[...t.undo].reverse();for(let n of e)await this.execAction(n);this.dispatchEvent(new CustomEvent("change",{detail:this}))}async execAction(t){switch(t.action){case"insert-range":await this.manipulator.insertRange(t);break;case"delete-range":this.manipulator.deleteRange(t);break;case"replace-range":await this.manipulator.replaceRange(t);break;case"fade-range":default:throw new Error("Internal error! Action not implemented "+t.action)}}async commit(t){if(this.operation.label=t,this.document.historyPosition<this.document.history.length-1)throw new Error("It says TODO here");this.document.history.push(this.operation),this.document.historyPosition=this.document.history.length-1,await this.storage.updateDocument(this.document),await this.storage.updateRecording(this.recording),this.operation={label:"",redo:[],undo:[]}}async deleteRange(t,e){const n={action:"delete-range",rangeStart:t,rangeEnd:e};this.operation.redo.push(n);const i=await this.createRecordingFromRange(t,e),r={action:"insert-range",rangeStart:t,bufferRecordingId:i.id};return this.operation.undo.push(r),await this.manipulator.deleteRange(n),i}async insertRange(t,e){if(e.id===0)throw Error("insert range must have recording id");const n={action:"insert-range",rangeStart:t,bufferRecordingId:e.id};this.operation.redo.push(n);const i={action:"delete-range",rangeStart:t,rangeEnd:e.buffers[0].length};this.operation.undo.push(i),await this.manipulator.insertRange(n)}async replaceRange(t,e){if(e.id===0)throw Error("insert range must have recording id");const n=e.buffers[0].length,i=await this.createRecordingFromRange(t,t+n);console.log("IS IT REALY",t,n,e,i);const r={action:"replace-range",rangeStart:t,bufferRecordingId:e.id};this.operation.redo.push(r);const c={action:"replace-range",rangeStart:t,bufferRecordingId:i.id};return this.operation.undo.push(c),await this.manipulator.replaceRange(r),i}beginRecording(){if(this.isRecording){console.warn("Already recording");return}this.isRecording=!0,this.playPosition=0,this.device.recorder.addEventListener("input",this.onRecordInput)}stopRecording(){if(!this.isRecording){console.warn("Not recording");return}console.log(this.operation,this.document),this.commit("Record Input"),this.device.recorder.removeEventListener("input",this.onRecordInput),this.isRecording=!1,this.dispatchEvent(new CustomEvent("end")),this.dispatchEvent(new CustomEvent("change"))}exportWav(t){}}class ae extends f{constructor(t,e){super(t);a(this,"document");a(this,"onDocumentChanged",()=>{this.refreshFromDocument()});this.document=e}async mounted(){this.document.addEventListener("change",this.onDocumentChanged),this.refreshFromDocument()}unmounted(){this.document.removeEventListener("change",this.onDocumentChanged)}refreshFromDocument(){this.props.historyPosition=this.document.document.historyPosition,this.props.rows=this.document.document.history.map((t,e)=>({selected:e==this.props.historyPosition,values:[t.label,t.redo.length,t.undo.length]}))}render(){return console.log("RENDERING RECORDINGSPANEL!"),[new L({content:[new I({content:[new h("span",{className:"hgi-stroke hgi-refresh"})],click:t=>this.refreshFromDocument()})]}),new Nt({rows:()=>this.props.rows})]}}class he extends f{constructor(){super({showAudioConfiguration:!0,showCreateNewDialog:!1,showStartRecording:!1,inputDevices:[],outputDevices:[],currentInputDeviceId:null,currentOutputDeviceId:null,inputMode:"stereo",microphonePermission:"denied",currentInputChannelCount:0,currentInputSampleRate:0,documentTabs:[],currentTab:0,initialized:!1});a(this,"storage");a(this,"device");a(this,"waveDocuments",[]);a(this,"onDeviceChange",async()=>{if(console.log("DEVICE CHANGE"),this.props.microphonePermission=await this.getMicrophonePermission(),this.props.microphonePermission==="prompt"){try{await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(e){if(e.message==="Permission dismissed"){this.props.microphonePermission="dismissed",this.props.showAudioConfiguration=!0;return}}if(this.props.microphonePermission=await this.getMicrophonePermission(),this.props.microphonePermission!=="granted"){this.props.showAudioConfiguration=!0;return}}const t=await navigator.mediaDevices.enumerateDevices();this.props.inputDevices=t.filter(e=>e.kind==="audioinput").map(e=>({text:e.label,value:e.deviceId})),this.props.outputDevices=t.filter(e=>e.kind==="audiooutput").map(e=>({text:e.label,value:e.deviceId})),this.props.currentInputDeviceId||(this.props.currentInputDeviceId=this.props.inputDevices[0].value),this.props.currentOutputDeviceId||(this.props.currentOutputDeviceId=this.props.outputDevices[0].value)});a(this,"onConfirmDevice",async t=>{console.log("DEVICE CONFIRM",t),await this.device.create(t.outputDeviceId,t.inputDeviceId),console.log("DEVICE CONFIRMED"),this.props.currentInputDeviceId=t.inputDeviceId,this.props.currentOutputDeviceId=t.outputDeviceId,this.props.inputMode=t.inputMode,this.props.showAudioConfiguration=!1});a(this,"onProbeDevice",async t=>{const n=(await navigator.mediaDevices.getUserMedia({audio:{advanced:[{deviceId:t.inputDeviceId}]},video:!1})).getAudioTracks();console.log("probing",n[0],n[0].getCapabilities());const i=n[0].getCapabilities();this.props.currentInputSampleRate=i.sampleRate.max,this.props.currentInputChannelCount=i.channelCount.max});a(this,"onCreateNew",async t=>{console.log("CREAATE NEW FROM ",t);const e=this.props.currentInputSampleRate,n=t.durationSec*e,i=[];for(let c=0;c<t.channelCount;c++)i.push(new Float32Array(n));const r=await this.storage.createRecording({sampleRate:e,buffers:i});await this.storage.createDocument({name:t.name,channelCount:i.length,sampleRate:e,sampleCount:n,recordingId:r,historyPosition:0,history:[]}),this.props.showCreateNewDialog=!1});a(this,"bufferSourceNode");a(this,"playTimer",null);a(this,"onPlay",t=>{if(this.bufferSourceNode){this.bufferSourceNode.stop();return}console.log("PLAY",this.device,t.props);const e=this.device.context,n=e.createBuffer(1,t.document.recording.buffers[0].length,e.sampleRate);n.getChannelData(0).set(t.document.recording.buffers[0]),this.bufferSourceNode=e.createBufferSource(),this.bufferSourceNode.buffer=n,this.bufferSourceNode.connect(e.destination),this.bufferSourceNode.addEventListener("ended",()=>{console.log("end of playback"),this.bufferSourceNode=null,clearInterval(this.playTimer)}),this.bufferSourceNode.start();const r=this.device.context.currentTime;this.playTimer=setInterval(()=>{const c=this.device.context.currentTime-r;t.document.setPlayPosition(c*this.device.context.sampleRate)},250)});a(this,"onRecord",t=>{if(t.document.isRecording){console.warn("AM recording - treating record button as stop button"),t.document.stopRecording();return}t.document.beginRecording()});this.storage=new se,this.device=new oe}async getMicrophonePermission(){return(await navigator.permissions.query({name:"microphone"})).state}async mounted(){await this.storage.open(),this.props.initialized=!0,navigator.mediaDevices.addEventListener("devicechange",this.onDeviceChange),this.onDeviceChange()}unMounted(){navigator.mediaDevices.removeEventListener("devicechange",this.onDeviceChange)}render(){const t=()=>{console.log("Show 'Create new' dialog"),this.props.showCreateNewDialog=!0},e=()=>{console.log("Show audio device dialog"),this.props.showAudioConfiguration=!0},n=async i=>{console.log("APP SELECT",i),i=await this.storage.getWaveDocument(i.id);const r=await this.storage.getRecording(i.recordingId);let c=this.waveDocuments.findIndex(d=>d.document.id===i.id),u;c===-1?(u=new J(this.device,this.storage,i,r),this.waveDocuments.push(u),this.props.documentTabs=[...this.props.documentTabs,{label:u.document.name,content:[new qt({play:d=>this.onPlay(d),record:d=>this.onRecord(d)},u)]}],console.log("NOW DOCUTBS",this.props.documentTabs),this.props.currentTab=this.waveDocuments.length-1):(u=this.waveDocuments[c],this.props.currentTab=c)};return[new K({title:"Audio Configuration",visible:()=>this.props.showAudioConfiguration,content:()=>[new Yt({currentInputDeviceId:()=>this.props.currentInputDeviceId,currentOutputDeviceId:()=>this.props.currentOutputDeviceId,inputDevices:()=>this.props.inputDevices,outputDevices:()=>this.props.outputDevices,microphonePermission:()=>this.props.microphonePermission,currentInputSampleRate:()=>this.props.currentInputSampleRate,currentInputChannelCount:()=>this.props.currentInputChannelCount,inputMode:()=>this.props.inputMode,inputSignal:0,confirm:i=>this.onConfirmDevice(i),refresh:()=>this.onDeviceChange(),change:i=>this.onProbeDevice(i)})]}),new K({title:"Create New",visible:()=>this.props.showCreateNewDialog,content:[new ne({name:"new-0001",sampleRate:()=>this.props.currentInputSampleRate,durationSec:60,channelCount:1,createNew:i=>this.onCreateNew(i),cancel:()=>{console.log("HERE WE ARE"),this.props.showCreateNewDialog=!1}})]}),new H(()=>this.props.initialized?new Rt({content:[new Pt({frames:[{where:"left",size:20,currentTab:0,tabs:[{title:"Recordings",content:[new Jt({recordings:[],createNew:i=>t(),device:i=>e(),select:i=>n(i)},this.storage)]},{title:"Debug",content:[new Et({})]},{title:"History",content:()=>[new ae({historyPosition:0,rows:[]},this.waveDocuments[this.props.currentTab])]}]},{where:"main",stack:"vertical",size:100,currentTab:0,tabs:this.props.documentTabs.map(i=>({title:i.label,content:i.content}))}]})]}):new p("Initializing..."))]}}const bt=new he,ce=bt.toDom(),It=document.querySelector("#app");k.mount(It);nt(It,ce);window.app=bt;
